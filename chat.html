<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat AiTrain</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: Inter, Segoe UI, Arial, Helvetica, sans-serif;
        }
        
        body {
            background: #0d0d0d;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .card {
            background: #1a1a1a;
            border-radius: 12px;
            border: 2px solid #ef4444;
            box-shadow: 0 0 20px #ef4444, 0 8px 30px rgba(2, 6, 23, 0.5);
            width: 100%;
            max-width: 1200px;
            display: flex;
            overflow: hidden;
            height: 90vh;
        }
        
        .left {
            flex: 1;
            padding: 40px;
            background: #000;
            color: #fff;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 16px;
        }
        
        .left .logo {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .left .logo img {
            width: 64px;
            height: auto;
        }
        
        .left h1 {
            font-size: 28px;
            margin-top: 6px;
            color: #fff;
        }
        
        .left p {
            color: rgba(255, 255, 255, 0.8);
            max-width: 320px;
            line-height: 1.4;
        }
        
        .features {
            margin-top: 20px;
        }
        
        .feature {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            color: #ccc;
        }
        
        .feature-icon {
            color: #ef4444;
            font-size: 14px;
        }
        
        .right {
            flex: 1.5;
            padding: 0;
            display: flex;
            flex-direction: column;
            background: #1a1a1a;
        }
        
        .chat-header {
            background: #000;
            color: #fff;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #ef4444;
        }
        
        .header-info h2 {
            font-size: 20px;
            color: #fff;
            margin-bottom: 4px;
            font-weight: 700;
        }
        
        .header-info p {
            color: #ccc;
            font-size: 13px;
        }
        
        .chat-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #0fff90;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            background: #0fff90;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .messages-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: #0d0d0d;
        }
        
        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 8px;
            line-height: 1.4;
            position: relative;
        }
        
        .bot-message {
            align-self: flex-start;
            background: #1a1a1a;
            border: 1px solid #333;
            color: #fff;
        }
        
        .user-message {
            align-self: flex-end;
            background: #ef4444;
            color: #fff;
        }
        
        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 5px;
            text-align: right;
        }
        
        .quick-actions {
            padding: 20px;
            border-top: 1px solid #333;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            background: #1a1a1a;
        }
        
        button {
            background: #ef4444;
            color: #fff;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 13px;
        }
        
        button:hover {
            background: #ff1a1a;
            transform: scale(1.03);
        }
        
        .btn-outline {
            background: transparent;
            border: 1px solid #ef4444;
            color: #ef4444;
        }
        
        .btn-outline:hover {
            background: #ef4444;
            color: #fff;
        }
        
        .btn-disabled {
            background: #666;
            color: #999;
            cursor: not-allowed;
        }
        
        .btn-disabled:hover {
            background: #666;
            transform: none;
        }
        
        .floating-buttons {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 100;
        }
        
        .floating-btn {
            background: #ef4444;
            color: #fff;
            border: none;
            padding: 12px 18px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 13px;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
            transition: all 0.3s ease;
        }
        
        .floating-btn:hover {
            background: #ff1a1a;
            transform: translateY(-2px);
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: #1a1a1a;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80%;
            overflow-y: auto;
            position: relative;
            border: 2px solid #ef4444;
            box-shadow: 0 0 20px #ef4444;
        }
        
        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 20px;
            cursor: pointer;
            color: #ef4444;
        }
        
        .card-modal {
            background: #000;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .card-modal h3 {
            color: #ef4444;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .card-modal ul {
            list-style: none;
            padding-left: 0;
        }
        
        .card-modal li {
            margin-bottom: 6px;
            padding-left: 15px;
            position: relative;
            color: #ccc;
        }
        
        .card-modal li:before {
            content: "‚Ä¢";
            color: #ef4444;
            position: absolute;
            left: 0;
        }
        
        /* Bot√≥n Volver Mejorado */
        .back-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border: none;
            color: #fff;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .back-btn:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(239, 68, 68, 0.4);
        }
        
        /* Nuevos estilos para organizar los botones */
        .top-actions {
            padding: 15px 30px;
            border-bottom: 1px solid #333;
            background: #000;
            display: flex;
            justify-content: flex-end;
        }
        
        .main-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }
        
        .options-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }
        
        .info-message {
            background: #1a1a1a;
            border: 1px solid #ef4444;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            color: #fff;
        }
        
        .info-message h4 {
            color: #ef4444;
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        .info-message p {
            color: #ccc;
            margin-bottom: 10px;
            line-height: 1.4;
        }
        
        @media (max-width: 780px) {
            .left {
                display: none;
            }
            
            .floating-buttons {
                position: relative;
                bottom: auto;
                right: auto;
                margin-top: 15px;
                flex-direction: row;
                justify-content: center;
            }
            
            .quick-actions {
                flex-direction: column;
            }
            
            .message {
                max-width: 90%;
            }
            
            .main-actions {
                flex-direction: column;
            }
            
            .options-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="card" role="main">
        <div class="left" aria-hidden="true">
            <div class="logo">
                <img src="brazo.png" alt="AiTrain logo" />
                <div style="font-weight:700;font-size:18px">Ai<span style="color:#ef4444">Train</span></div>
            </div>
            <h1>Asistente de Entrenamiento</h1>
            <p>Consulta rutinas personalizadas, planes nutricionales y obt√©n recomendaciones inteligentes para tu progreso.</p>
            
            <div class="features">
                <div class="feature">
                    <span class="feature-icon">‚úì</span>
                    <span>Rutinas personalizadas con IA</span>
                </div>
                <div class="feature">
                    <span class="feature-icon">‚úì</span>
                    <span>Plan nutricional adaptado</span>
                </div>
                <div class="feature">
                    <span class="feature-icon">‚úì</span>
                    <span>Seguimiento de progreso</span>
                </div>
                <div class="feature">
                    <span class="feature-icon">‚úì</span>
                    <span>Recomendaciones inteligentes</span>
                </div>
            </div>
        </div>

        <div class="right">
            <!-- Secci√≥n superior con el bot√≥n de volver a inicio -->
            <div class="top-actions">
                <button class="back-btn" onclick="volverAlDashboard()">
                    <i class="fas fa-home"></i> Volver a Inicio
                </button>
            </div>
            
            <div class="chat-header">
                <div class="header-info">
                    <h2>AiTrain Assistant</h2>
                    <p>Especialista en fitness y nutrici√≥n</p>
                </div>
                <div class="chat-status">
                    <div class="status-dot"></div>
                    <span>En l√≠nea</span>
                </div>
            </div>
            
            <div class="messages-container" id="messagesContainer">
                <!-- Mensajes se cargar√°n aqu√≠ din√°micamente -->
            </div>
            
            <div class="quick-actions" id="quickActions">
                <div class="main-actions">
                    <button id="btnValoracion">
                        <i class="fas fa-chart-line"></i> Ver mi Valoraci√≥n
                    </button>
                    <button id="btnGenerarRutina">
                        <i class="fas fa-dumbbell"></i> Generar Rutina y Plan Alimenticio
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Botones flotantes -->
        <div class="floating-buttons">
            <button class="floating-btn" id="btnUltimaRutina">
                <i class="fas fa-dumbbell"></i> Ver √öltima Rutina
            </button>
            <button class="floating-btn" id="btnUltimaAlimentacion">
                <i class="fas fa-apple-alt"></i> Ver √öltimo Plan
            </button>
        </div>
    </div>

    <!-- Modal -->
    <div id="modalInfo" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        // Elementos del DOM
        const messagesContainer = document.getElementById('messagesContainer');
        const quickActions = document.getElementById('quickActions');
        const modal = document.getElementById("modalInfo");
        const modalBody = document.getElementById("modalBody");
        const modalClose = document.querySelector(".modal-close");
        
        const userId = localStorage.getItem("aitrain_user") || "usuario@ejemplo.com";
        let estadoChat = 'inicio';
        let objetivoUsuario = '';
        let diasUsuario = 0;
        let rutinaGenerada = false;
        let tieneValoracion = false;

        // MODAL
        modalClose.onclick = () => modal.style.display = "none";
        window.onclick = (e) => { 
            if(e.target == modal) modal.style.display = "none"; 
        };
        function mostrarModal(html){ 
            modalBody.innerHTML = html; 
            modal.style.display = "flex"; 
        }

        // AGREGAR MENSAJE
        function addMessage(text, sender='bot'){
            const msg = document.createElement('div');
            msg.classList.add('message', sender === 'bot' ? 'bot-message' : 'user-message');
            
            const time = new Date().toLocaleTimeString('es-ES', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            msg.innerHTML = `
                ${text}
                <div class="message-time">${time}</div>
            `;
            
            messagesContainer.appendChild(msg);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // MENSAJE BIENVENIDA
        addMessage('¬°Hola! Bienvenido a AiTrain. Estoy aqu√≠ para ayudarte a mejorar tu entrenamiento y alimentaci√≥n.');

        // HELPER POST
        async function postJson(url, body){
            const res = await fetch(url, {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify(body)
            });
            let data;
            try{ data = await res.json(); } catch(e){ data = await res.text(); }
            if(!res.ok) throw new Error(data.mensaje || data || 'Error en la petici√≥n');
            return data;
        }

        // VERIFICAR SI EL USUARIO TIENE VALORACI√ìN
        async function verificarValoracion() {
            try {
                const res = await fetch(`http://localhost:8080/api/aitrain/valoracion/buscar/${userId}`);
                if(!res.ok) throw new Error('Error al verificar valoraci√≥n');
                const data = await res.json();
                tieneValoracion = !!data.valoracion;
                return tieneValoracion;
            } catch(err) { 
                console.error('Error al verificar valoraci√≥n:', err);
                tieneValoracion = false;
                return false;
            }
        }

        // MOSTRAR MENSAJE DE ERROR CUANDO NO HAY VALORACI√ìN
        function mostrarErrorValoracion() {
            addMessage('‚ö†Ô∏è <strong>No puedes generar rutinas o planes sin antes completar tu valoraci√≥n f√≠sica</strong><br><br>Por favor, ve a tu perfil y completa la valoraci√≥n f√≠sica para poder crear planes personalizados seg√∫n tus caracter√≠sticas.');
            
            // Crear bot√≥n para ir al perfil
            setTimeout(() => {
                const btnPerfil = document.createElement('button');
                btnPerfil.className = 'btn-outline';
                btnPerfil.innerHTML = '<i class="fas fa-user"></i> Ir a mi Perfil';
                btnPerfil.addEventListener('click', () => {
                    window.location.href = 'perfil.html';
                });
                
                quickActions.innerHTML = '';
                quickActions.appendChild(btnPerfil);
            }, 500);
        }

        // MOSTRAR MENSAJE INFORMATIVO SOBRE LA VALORACI√ìN
        function mostrarMensajeValoracion() {
            const infoMessage = document.createElement('div');
            infoMessage.className = 'info-message';
            infoMessage.innerHTML = `
                <h4>üìã Primero necesitas completar tu valoraci√≥n f√≠sica</h4>
                <p>Para generar rutinas y planes de alimentaci√≥n personalizados, es necesario que primero completes tu valoraci√≥n f√≠sica en la secci√≥n de perfil.</p>
                <p>La valoraci√≥n incluye:</p>
                <ul>
                    <li>Peso y estatura</li>
                    <li>Medidas corporales</li>
                    <li>Nivel de condici√≥n f√≠sica</li>
                    <li>Objetivos personales</li>
                </ul>
                <p>¬°Esta informaci√≥n nos ayuda a crear planes que se adapten perfectamente a ti!</p>
            `;
            
            messagesContainer.appendChild(infoMessage);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // VER VALORACI√ìN
        document.getElementById('btnValoracion').addEventListener('click', async ()=>{
            try{
                const res = await fetch(`http://localhost:8080/api/aitrain/valoracion/buscar/${userId}`);
                if(!res.ok) throw new Error('Error al obtener valoraci√≥n');
                const data = await res.json();
                if(data.valoracion){
                    const v = data.valoracion;
                    addMessage(`üìä <strong>Tu valoraci√≥n actual:</strong><br>
                               ‚Ä¢ Peso: ${v.pesoKg} kg<br>
                               ‚Ä¢ Estatura: ${v.estaturaCm} cm<br>
                               ‚Ä¢ IMC: ${v.imc.toFixed(2)}`);
                    tieneValoracion = true;
                    
                    // Mostrar mensaje de √©xito
                    setTimeout(() => {
                        addMessage('‚úÖ ¬°Perfecto! Ya tienes tu valoraci√≥n completa. Ahora puedes generar rutinas y planes de alimentaci√≥n personalizados.');
                    }, 1000);
                } else {
                    addMessage('‚ùå <strong>No se encontr√≥ valoraci√≥n para este usuario.</strong><br><br>Por favor, completa tu valoraci√≥n f√≠sica en tu perfil para poder acceder a todas las funciones personalizadas.');
                    tieneValoracion = false;
                    mostrarMensajeValoracion();
                }
            }catch(err){ 
                addMessage('‚ö†Ô∏è No se pudo obtener tu valoraci√≥n.', 'bot'); 
                console.error(err);
                tieneValoracion = false;
                mostrarMensajeValoracion();
            }
        });

        // GENERAR RUTINA Y PLAN CON VERIFICACI√ìN
        document.getElementById('btnGenerarRutina').addEventListener('click', async () => {
            // Verificar si tiene valoraci√≥n antes de continuar
            const tieneValor = await verificarValoracion();
            
            if (!tieneValor) {
                mostrarErrorValoracion();
                mostrarMensajeValoracion();
                return;
            }
            
            if (rutinaGenerada) {
                addMessage('Ya tienes una rutina generada. Si deseas crear una nueva, por favor recarga la p√°gina.');
                return;
            }
            
            addMessage('¬°Excelente! Vamos a crear tu rutina personalizada. Primero, ¬øcu√°l es tu objetivo principal?');
            mostrarOpcionesObjetivo();
        });

        // FRASES MOTIVADORAS
        const frasesMotivadoras = [
            '¬°Vamos, t√∫ puedes! üí™',
            'Cada repetici√≥n te acerca a tu objetivo.',
            '¬°Entrena con constancia y ver√°s resultados!',
            'Hoy es un buen d√≠a para superarte.',
            '¬°No te rindas, tu esfuerzo vale!'
        ];

        // BOTONES DE OBJETIVO
        function mostrarOpcionesObjetivo() {
            const objetivos = ['Definici√≥n', 'Volumen', 'Fuerza', 'Resistencia'];
            quickActions.innerHTML = ''; // limpiar botones
            
            const optionsContainer = document.createElement('div');
            optionsContainer.className = 'options-container';
            
            objetivos.forEach(obj => {
                const btn = document.createElement('button');
                btn.className = 'btn-outline';
                btn.innerHTML = `<i class="fas fa-target"></i> ${obj}`;
                btn.addEventListener('click', () => {
                    objetivoUsuario = obj;
                    addMessage(`‚úÖ Objetivo seleccionado: ${obj}`);
                    addMessage(fraseAleatoria());
                    estadoChat = 'dias';
                    mostrarOpcionesDias();
                });
                optionsContainer.appendChild(btn);
            });
            
            quickActions.appendChild(optionsContainer);
        }

        // BOTONES DE D√çAS
        function mostrarOpcionesDias() {
            addMessage('Perfecto, ahora selecciona cu√°ntos d√≠as a la semana quieres entrenar:');
            const dias = [1,2,3,4,5,6,7];
            quickActions.innerHTML = '';
            
            const optionsContainer = document.createElement('div');
            optionsContainer.className = 'options-container';
            
            dias.forEach(d => {
                const btn = document.createElement('button');
                btn.className = 'btn-outline';
                btn.textContent = `${d} d√≠a${d > 1 ? 's' : ''}`;
                btn.addEventListener('click', () => {
                    diasUsuario = d;
                    addMessage(`‚úÖ D√≠as seleccionados: ${d}`);
                    addMessage(fraseAleatoria());
                    estadoChat = 'confirmar';
                    mostrarBotonGenerar();
                });
                optionsContainer.appendChild(btn);
            });
            
            quickActions.appendChild(optionsContainer);
        }

        // BOT√ìN GENERAR PLAN Y RUTINA
        function mostrarBotonGenerar() {
            quickActions.innerHTML = '';
            const btn = document.createElement('button');
            btn.textContent = 'Generar Rutina y Plan Alimenticio';
            btn.addEventListener('click', generarRutinaPlanDinamico);
            quickActions.appendChild(btn);
        }

        // FUNCION PARA ELEGIR FRASE ALEATORIA
        function fraseAleatoria() {
            return frasesMotivadoras[Math.floor(Math.random() * frasesMotivadoras.length)];
        }

        // FUNCION PARA GENERAR RUTINA Y PLAN DINAMICO
        async function generarRutinaPlanDinamico() {
            addMessage('‚åõ Generando tu rutina y plan alimenticio...');
            
            const rutina = generarRutina(objetivoUsuario, diasUsuario);
            const planAlimenticio = generarPlan(objetivoUsuario, diasUsuario);

            try {
                await postJson('http://localhost:8081/api/aitrain/rutinas/save', rutina);
                await postJson('http://localhost:8082/api/aitrain/nutricion/save', planAlimenticio);
                addMessage('‚úÖ Rutina y plan alimenticio generados exitosamente!');
                addMessage(fraseAleatoria());

                rutinaGenerada = true;

                // A√ëADIR BOT√ìN PARA IR AL DASHBOARD
                setTimeout(() => {
                    const btnDashboard = document.createElement('button');
                    btnDashboard.className = 'back-btn';
                    btnDashboard.innerHTML = '<i class="fas fa-chart-bar"></i> Ver en Dashboard';
                    btnDashboard.addEventListener('click', () => {
                        window.location.href = 'dashboard_usuario.html';
                    });
                    
                    quickActions.innerHTML = '';
                    quickActions.appendChild(btnDashboard);
                }, 1000);

            } catch(err) {
                addMessage(`‚ö†Ô∏è Error al generar rutina y plan: ${err.message}`, 'bot'); 
                console.error(err);
            }
        }

        // GENERADOR DIN√ÅMICO DE RUTINAS
        function generarRutina(objetivo, dias) {
            const ejerciciosBase = {
                'Definici√≥n': ['Cardio', 'Burpees', 'Jumping Jacks', 'Plancha', 'Mountain Climbers', 'Saltar cuerda', 'Abdominales'],
                'Volumen': ['Press de banca', 'Sentadillas', 'Peso muerto', 'Dominadas', 'Curl b√≠ceps', 'Fondos triceps', 'Remo con barra'],
                'Fuerza': ['Sentadillas pesadas', 'Press militar', 'Peso muerto', 'Fondos triceps', 'Dominadas lastradas', 'Press banca inclinado'],
                'Resistencia': ['Correr', 'Saltos', 'Flexiones', 'Remo', 'Bicicleta est√°tica', 'Burpees', 'Plancha din√°mica']
            };

            const diasSemana = ['Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado','Domingo'];
            let rutina = { userId, nombre:`Rutina ${objetivo}`, objetivo, duracionSemanas:4, fechaCreacion:new Date().toISOString().split('T')[0], dias:[] };

            for(let i=0;i<dias;i++){
                let listaEjercicios = ejerciciosBase[objetivo].sort(()=>0.5-Math.random()).slice(0, 3 + Math.floor(Math.random()*3));
                let ejercicios = listaEjercicios.map(e => ({
                    nombre:e,
                    series: 3 + Math.floor(Math.random()*3),
                    repeticiones: 8 + Math.floor(Math.random()*8),
                    tiempo: `${20 + Math.floor(Math.random()*40)}s`
                }));
                rutina.dias.push({ nombreDia: diasSemana[i], ejercicios });
            }
            return rutina;
        }

        // GENERADOR DIN√ÅMICO DE PLAN ALIMENTICIO
        function generarPlan(objetivo, dias) {
            const comidasBase = {
                'Definici√≥n':[
                    {"nombre":"Desayuno","descripcion":"Avena con frutas y yogurt","calorias":300+Math.floor(Math.random()*50)},
                    {"nombre":"Almuerzo","descripcion":"Pechuga de pollo con ensalada","calorias":450+Math.floor(Math.random()*100)},
                    {"nombre":"Cena","descripcion":"Pescado al horno con verduras","calorias":350+Math.floor(Math.random()*50)}
                ],
                'Volumen':[
                    {"nombre":"Desayuno","descripcion":"Huevos con pan integral y avena","calorias":400+Math.floor(Math.random()*50)},
                    {"nombre":"Almuerzo","descripcion":"Pollo con arroz y pasta","calorias":700+Math.floor(Math.random()*100)},
                    {"nombre":"Cena","descripcion":"Batido proteico con frutos secos","calorias":500+Math.floor(Math.random()*50)}
                ],
                'Fuerza':[
                    {"nombre":"Desayuno","descripcion":"Batido proteico con avena","calorias":350+Math.floor(Math.random()*50)},
                    {"nombre":"Almuerzo","descripcion":"Carne con papas y verduras","calorias":650+Math.floor(Math.random()*100)},
                    {"nombre":"Cena","descripcion":"Salm√≥n con quinoa","calorias":450+Math.floor(Math.random()*50)}
                ],
                'Resistencia':[
                    {"nombre":"Desayuno","descripcion":"Frutas y yogurt","calorias":300+Math.floor(Math.random()*50)},
                    {"nombre":"Almuerzo","descripcion":"Pescado con quinoa y vegetales","calorias":550+Math.floor(Math.random()*100)},
                    {"nombre":"Cena","descripcion":"Ensalada de at√∫n con aguacate","calorias":400+Math.floor(Math.random()*50)}
                ]
            };

            const diasSemana = ['Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado','Domingo'];
            let plan = { userId, nombre:`Plan ${objetivo}`, objetivo, dias:[] };

            for(let i=0;i<7;i++){
                const comidas = comidasBase[objetivo].map(c => ({
                    nombre: c.nombre,
                    descripcion: c.descripcion,
                    calorias: c.calorias
                }));
                plan.dias.push({ nombreDia:diasSemana[i], comidas });
            }

            return plan;
        }

        // BOTONES FLOTANTES
        document.getElementById("btnUltimaRutina").addEventListener("click", async ()=>{
            try{
                const res = await fetch(`http://localhost:8081/api/aitrain/rutinas/usuario/${userId}`);
                if(!res.ok) throw new Error('Error al obtener rutina');
                const data = await res.json();
                if(Array.isArray(data) && data.length>0){
                    const ultima = data[data.length-1];
                    let html = `<div class="card-modal"><h3>üìã Tu √öltima Rutina</h3>`;
                    ultima.dias.forEach(dia=>{
                        html += `<strong>${dia.nombreDia}:</strong><ul>`;
                        dia.ejercicios.forEach(e=>html+=`<li>${e.nombre}: ${e.series}x${e.repeticiones} (${e.tiempo})</li>`);
                        html += `</ul>`;
                    });
                    html += `</div>`;
                    mostrarModal(html);
                }else mostrarModal('<p>No se encontr√≥ rutina para este usuario.</p>');
            }catch(err){ mostrarModal(`<p>‚ö† Error al obtener rutina: ${err.message}</p>`); console.error(err);}
        });

        document.getElementById("btnUltimaAlimentacion").addEventListener("click", async ()=>{
            try{
                const res = await fetch(`http://localhost:8082/api/aitrain/nutricion/usuario/${userId}`);
                if(!res.ok) throw new Error('Error al obtener plan alimenticio');
                const data = await res.json();
                if(Array.isArray(data) && data.length>0){
                    const ultimo = data[data.length-1];
                    let html = `<div class="card-modal"><h3>ü•ó Tu √öltimo Plan Alimenticio</h3>`;
                    ultimo.dias.forEach(dia=>{
                        html += `<strong>${dia.nombreDia}:</strong><ul>`;
                        dia.comidas.forEach(c=>html+=`<li>${c.nombre}: ${c.descripcion} (${c.calorias} kcal)</li>`);
                        html += `</ul>`;
                    });
                    html += `</div>`;
                    mostrarModal(html);
                }else mostrarModal('<p>No se encontr√≥ plan alimenticio para este usuario.</p>');
            }catch(err){ mostrarModal(`<p>‚ö† Error al obtener plan: ${err.message}</p>`); console.error(err);}
        });

        // VOLVER AL DASHBOARD
        function volverAlDashboard() {
            window.location.href = 'dashboard_usuario.html';
        }

        // VERIFICAR VALORACI√ìN AL CARGAR LA P√ÅGINA
        window.addEventListener('DOMContentLoaded', async () => {
            await verificarValoracion();
            
            // Mostrar mensaje informativo si no tiene valoraci√≥n
            if (!tieneValoracion) {
                setTimeout(() => {
                    mostrarMensajeValoracion();
                }, 1500);
            }
        });
    </script>

    <!-- Font Awesome para √≠conos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
</body>
</html>